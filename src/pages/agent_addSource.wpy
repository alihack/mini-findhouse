<style lang="less" scoped>
@import '../styles/base.less';
.container {
	width: 100%;
	height: 100%;
	background: #fff;
  	box-sizing: border-box;
	align-items: center;
	padding-top:20rpx;
	padding-bottom: 80rpx;
	.search-warp {
		margin-bottom: 30rpx;
		.search {
			display: flex;
			flex-wrap:wrap;
			margin: 0 auto;
			background: #f5f5f5;
			input {
				width: 570rpx;
				height: 70rpx;
				padding: 0 20rpx;
				box-sizing: border-box;
				line-height: 70rpx;
				border-radius: 5rpx;
			}
			.icon {
				width: 60rpx;
				height: 70rpx;
				text-align: center;
				line-height: 70rpx;
				box-sizing: border-box;
				image {
					width: 35rpx;
					height: 35rpx;
					padding:15rpx;
				}
			}
			.icon1 {
				.icon;
				border-top-left-radius: 60rpx;
				border-bottom-left-radius: 60rpx;
			}
			.icon2 {
				.icon;
				border-top-right-radius: 60rpx;
				border-bottom-right-radius: 60rpx;
			}
		}
	}
	.item {
		padding:30rpx;
		background: #fff;
		width: 100%;
		height: 210rpx;
		box-sizing: border-box;
		border-top:2rpx solid #f5f5f5;
		color:@gray;
		.title {
			.flex;
			.frame {
				width: 30rpx;
				height: 30rpx;
				border:2rpx solid @gray;
				border-radius: 5rpx;
				line-height: 40rpx;
				image {
					width: 30rpx;
					height: 30rpx;
				}
			}
			.label {
				.label-auto(80rpx, 35rpx);
				background: #5dacff;
				color:#fff;
				margin:0 20rpx;
				font-size: 24rpx;
			}
			.name {
				font-size: 32rpx;
				color:black;
			}
		}
		.code, .detail {margin: 10rpx 50rpx}
	}
	.item:first-child {border:none}
	.button {
		margin-top:50rpx;
	}
}
.button {
	position: fixed;
	bottom: 20rpx;
}
</style>
<template>
<view class="container">
	<view class="search-warp">
		<view class="search">
			<view class="icon1">
				<image src="../images/search.png"></image>
			</view>
			<input placeholder="输入小区关键词/房源编号搜索" @confirm="onConfirm" value="{{searchText}}"/>
			<view class="icon2">
				<image wx:if="{{isSearched}}" src="../images/clear.png" @tap="clearSearch"></image>
			</view>
		</view>
	</view>
	<block wx:if="{{sourceList.length}}">
		<view class="item" wx:for="{{sourceList}}" wx:key="index"  @tap="toggleFrame({{index}})">
			<view class="title">
				<view class="frame">
					<image src="../images/tick.png" wx:if="{{item.isSelected}}"></image>
				</view>
				<view class="label">归属人</view>
				<text class="name">{{item.deptName1}} {{item.employeeName1}}</text>
			</view>
			<view class="code">编号：{{item.propertyNo}}</view>
			<view class="detail">{{item.estateName}}/{{item.countF}}室{{item.countT}}厅</view>
		</view>
	</block>
	<view class="button" @tap="add">添加</view>
	<view wx:if="{{isNoData}}" class='nodata'>没有搜索到相关的数据哦</view>
</view>
</template>

<script>
import wepy from 'wepy'
import api from '../utils/api'
export default class addSource extends wepy.page {
	config = {
		navigationBarTitleText: '添加房源',
		navigationBarBackgroundColor: '#f5f5f5',
		enablePullDownRefresh: false
	}
	components = {
	}
    data = {
		searchText: '',
		isSearched: false,
		isChoosed: false,
		sourceList: [],
		agentHouses: [],
		isNoData: false
	}
	async onLoad() {
		// 获取前一页面数据
		const pages = getCurrentPages()
		const prevPage = pages[pages.length - 2]
		this.agentHouses = prevPage.data.agentHouses
		this.$apply()
	}
	methods = {
		onConfirm: async ({detail: {value}}) => {
			wx.showLoading({
				title: '搜索中',
			})
			const {data: {list}} = await wepy.request({
				url: api['searchHouses'],
				data: {
					estateName: value,
					page: 1,
					pagesize: 999
				}
			})
			if (list) {
					list.forEach(listItem => {
						// 搜索结果中包含经纪人已添加的房源
						this.agentHouses.forEach(agentItem => {
							if (listItem.propertyUuid == agentItem.property_uuid) {
								console.log('ture')
								listItem.isSelected = true
							} else {
								listItem.isSelected = false
							}
							this.$apply()
						})
					})
					this.isNoData = false
				} else {
					this.isNoData = true
				}
			this.sourceList = list
			wx.hideLoading()
			this.$apply()
		},
		clearSearch() {
			this.isSearched = false
			this.searchText = ''
			this.sourceList = []
		},
		setCommunityName(item) {
			console.log(item)
			this.isChoosed = true
		},
		async toggleFrame(index) {
			this.sourceList[index].isSelected = !this.sourceList[index].isSelected
			this.$apply()
		},
		async add() {
			const selectedArry = this.sourceList.filter(ele => ele.isSelected == true)
			const uid = wepy.$instance.globalData.myUserInfo.uid
			selectedArry.forEach(async ele => {
				await wepy.request({
					url: api['addHouses'],
					method: 'POST',
					data: {
						uid: uid,
						propertyUuid: ele.propertyUuid
					}
				})
			})
			wx.showToast({
				title: '添加成功'
			})
			setTimeout(() => {
				wepy.navigateBack()
			}, 1000)
		}
	}
}
</script>
